---
title: "ISA 401: Business Intelligence & Data Visualization"
subtitle: "07: Connecting to APIs in R"
author: "<br>Fadel M. Megahed, PhD <br><br> Associate Professor <br> Department of Information Systems and Analytics <br> Farmer School of Business<br> Miami University<br><br>Twitter: [FadelMegahed](www.twitter.com/FadelMegahed/)<br> GitHub: [fmegahed](https://github.com/fmegahed)<br> Email: [fmegahed@miamioh.edu](mailto:fmegahed@miamioh.edu)<br> Office Hours: [Automated Scheduler for Virtual Office Hours](https://calendly.com/fmegahed)<br><br>"
date: "Spring 2022"
output:
  xaringan::moon_reader:  
    css: [default, "css/fonts.css", "css/my-theme.css", "css/my-theme.css"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: "16:9"
header-includes:  
  - "header.html"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE,
                      echo = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      progress = FALSE, 
                      verbose = FALSE,
                      dev = 'png',
                      fig.height = 2.5,
                      dpi = 300,
                      fig.align = 'center')

options(htmltools.dir.version = FALSE)

miamired = '#C3142D'

if(require(pacman)==FALSE) install.packages("pacman")
if(require(devtools)==FALSE) install.packages("devtools")

if(require(countdown)==FALSE) devtools::install_github("gadenbuie/countdown")
if(require(xaringanExtra)==FALSE) devtools::install_github("gadenbuie/xaringanExtra")


pacman::p_load(tidyverse, magrittr, lubridate, janitor, # data analysis pkgs
               httr, jsonlite, tidycensus, # for APIs
               fontawesome, RefManageR, xaringanExtra, countdown) # for slides

BibOptions(check.entries = FALSE, bib.style = "authoryear", 
           style = "markdown", dashed = TRUE)

bib = ReadBib("refs.bib") 
```

```{r xaringan-themer, include=FALSE, warning=FALSE}
if(require(xaringanthemer) == FALSE) install.packages("xaringanthemer")
library(xaringanthemer)

style_mono_accent(base_color = "#84d6d3",
                  base_font_size = "20px")

xaringanExtra::use_xaringan_extra(c("tile_view", "animate_css", "tachyons", "panelset", "broadcast", "share_again", "search", "fit_screen", "editable", 
                                    "clipable"))
```


# Quick Refresher from Last Week


`r emo::ji("check")` Understand when can we scrape data (i.e., `robots.txt`)  

`r emo::ji("check")` Scrape a webpage Using `r fontawesome::fa("r-project", fill = miamired)`  

`r emo::ji("check")` Utilize loops or `purr::map` to download data from multiple webpages.  


---

# Learning Objectives for Today's Class

- Describe what is an API 

- Download data using APIs


---
class: inverse, center, middle

# What is an API?

---

# What is an API? [1]

- An **API** is an acronym for application programming interface. 

- It is a **popular** approach to interact with an application/service or data since it:  
  * Defines a set of functionalities independent of implementation (i.e., it only exposes information that a programmer might find useful and keep those parts consistent even if the implementation changes later)
  * Provides some level of privacy/control over one's internal data and the rate at which it can be accessed. 

---

# What is an API? [2]

<center>

<iframe width="896" height="504" src="https://www.youtube.com/embed/s7wmiS2mSXY" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

</center>


---

# What is an API?  [3]

.center[**Scenario:** Alone, you went into a warehouse and are trying to retrieve 3 screwdrivers, a toolbox, and 15 phillips screws. But you do not know, where those things are in the warehouse.]

```{r api_as_a_warehouse, echo=FALSE, out.width='60%', fig.cap='The API is the set of instructions provided by the warehouse manager on where/how to retrieve this information without touching/accessing other things in there.'}

knitr::include_graphics("https://miro.medium.com/max/1400/1*oklkpcOX4lpttIAsd2gwXg.jpeg")
```

.footnote[
<html>
<hr>
</html>
**Source:** [Matt Z. (2018). What is an API? (explanation with cartoon picture so a 5 year old could understand it)](https://medium.com/@xiang_zhou/what-is-an-api-explanation-with-cartoon-picture-so-a-5-year-old-could-understand-it-6c6c42b75be4)
]

---
class: inverse, center, middle

# Accessing APIs in R

---

# The 3 Step Process

Before you dive into the API documentation, you **should first check if there is a R (or Python if you are familiar)** package/library that serves as a wrapper for that API.

1. **Find** the **API's documentation** and find information about the following:  
  A. Does the API require an **authentication key**?   
  B. What are the API's **base URL** and **query parameters**?  
  C. How does the request URL look like?  
  
2.Craft your **request**. My recommendations are to:  
  A. First, start with a simple request.  
  B. Test that request in your browser and see what results you get.   
  
3. Construct that request in `r fontawesome::fa("r-project", fill = miamired)` by **either**:
  A. If the generated content seems to be a `JSON` file/webpage, you can capitalize on the 
    reading the content from `jsonlite::fromJSON()`; **OR**  
  B. By passing the `base url` inside the `httr::GET()` and parsing the results with `httr::content()`. 


---

# Demo 1: `tidycensus` vs Census API

.panelset[

.panel[.panel-name[Motivation]

.small[
In socio-economic analysis, we are often interested in examining explanatory population-level variables. For the U.S., the decennial (once every 10 ten years) Census, and the  1-year and 5-year American Community Surveys are often the gold-standard for such data. 

Luckily, the [tidycensus](https://walker-data.com/tidycensus/index.html) is an R package that allows users to interface with a select number of the US Census Bureauâ€™s data APIs and return tidyverse-ready data frames.
]

]

.panel[.panel-name[Learning Objectives]
> In this demo, we will:
> - Set up an API key for the Census API
> - Use the `tidycensus` package to obtain the total population for Butler and Warren Counties in Ohio from <https://api.census.gov/data/2020/dec/pl/variables.html>
> - Extract the same data by capitalizing on the API itself (i.e., without the tidycensus package)

]

.panel[.panel-name[`tidycensus` Results]

> In class, we will live code and capitalize on the `tidycensus` package to get the  
total population for Butler and Warren Counties in Ohio from <https://api.census.gov/data/2020/dec/pl/variables.html> 

```{r butler_county_2021, echo=FALSE}
census_api_key(Sys.getenv('census_key'))

butler_warren = get_decennial(geography = 'county',
                              state = 'OH',
                              county = c('Butler County', 'Warren County'),
                              variables = 'P1_001N',
                              year = 2020)

print(butler_warren)

```

]

.panel[.panel-name[Direct Results]

> In class, we will live code and capitalize on the `tidycensus` package to get the  
total population for Butler and Warren Counties in Ohio from <https://api.census.gov/data/2020/dec/pl/variables.html> 

```{r census_api, echo=FALSE}
fips_counties = c('39017', '39165')

base_url = 'http://api.census.gov/data/2020/dec/pl.json/'

census_response = fromJSON(txt =  'https://api.census.gov/data/2020/dec/pl.json?get=P1_001N&for=county:017,165&in=state:39'
) %>% as_tibble() %>% 
  janitor::row_to_names(row_number = 1)

census_response
```

]

]



---

# Demo 2: Accuweather API

.panelset[

.panel[.panel-name[Demo Description]

> - Go to <https://developer.accuweather.com/> and create an account. 
> - Add your first app (from the `MY APPS` tab) and copy the generated API key. 
> - Then using the API Reference Tab `r fontawesome::fa('arrow-right', fill = miamired)` Locations API `r fontawesome::fa('arrow-right', fill = miamired)` City Search `r fontawesome::fa('arrow-right', fill = miamired)` find the location key for `Oxford, Ohio` 
> - Use this information in the `Forecast API` to obtain the `5 Day Forecasts` for `Oxford Ohio`. 

]


.panel[.panel-name[Code and Results]

```{r accu_weather_results, echo=FALSE}
base_accu_url = 'http://dataservice.accuweather.com/forecasts/v1/daily/5day/340019?apikey=mDyIYQMWJGLgEiAmGkEIlkoS3I4JYAwo'

base_accu_url %>% fromJSON() -> accu_response

glimpse(accu_response)

```

]



]


---

# Demo 3: The CryptoCompare API

.panelset[

.panel[.panel-name[Demo Description]

.small[
- Create a Personal (Free) account at [CryptoCompare.com](https://min-api.cryptocompare.com/pricing)   
- Click on create your free key to create your API key and copy the key.  
- Go to the [documentation](https://min-api.cryptocompare.com/documentation), and test their sample call by executing the call after you have pasted your API key in the call.  
  - The executed call returns the price of BTC (Bitcoin) in USD, JPY and EUR. 
- Now click on the Historical Data Tab on the left  
  - Click on Daily Pair OHLCV and Execute the Sample Call for BTC  
  - This returns 10 days worth of OHLCV for BTC in USD.  
- Let us obtain the price for $SHIB over the past 100 days.
]

]

.panel[.panel-name[Code and Results]

```{r crypto, echo = FALSE}
crypto = jsonlite::fromJSON("https://min-api.cryptocompare.com/data/histoday?fsym=SHIB&tsym=USD&limit=100") %>% .[['Data']]

crypto$time = lubridate::as_datetime(crypto$time) %>% lubridate::as_date()

crypto %>% tail(6) %>% select(time, high, low, open, close)

```

]

]



---
class: inverse, center, middle

# Recap

---

# Summary of Main Points

By now, you should be able to do the following:

- Describe what is an API 

- Download data using APIs


---

# Supplementary Reading on Accessing APIs


* [Getting Started with httr](https://cran.r-project.org/web/packages/httr/vignettes/quickstart.html)  
* [Managing secrets](https://httr.r-lib.org/articles/secrets.html)  




